package evchargingstore.service;

import java.util.UUID;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import evchargingstore.entity.ChargingSessionInfo;
import evchargingstore.entity.ChargingSessionResponse;
import evchargingstore.entity.ChargingSessionStatisticsResponse;
import evchargingstore.entity.ChargingSessionStatus;
import evchargingstore.repository.ChargingSessionRepository;

@Service
public class ChargingSessionService {

	@Autowired
	private ChargingSessionRepository chargingSessionRepository;

	public ChargingSessionResponse submitChargingSession(ChargingSessionInfo sessionInfo) {
		sessionInfo.setId(UUID.randomUUID().toString());
		sessionInfo.setStartedAt(sessionInfo.getStartedAt());
		sessionInfo.setStatus(ChargingSessionStatus.STARTED);
		ChargingSessionInfo savedInfo = chargingSessionRepository.save(sessionInfo);
		return new ChargingSessionResponse(savedInfo);
	}

	public ChargingSessionResponse suspendChargingSession(ChargingSessionInfo sessionInfo) {
		return chargingSessionRepository.findById(sessionInfo.getId()).map(infoIfExisted -> {
			if (infoIfExisted.getStatus() == ChargingSessionStatus.SUSPENDED) {
				return new ChargingSessionResponse("Session with this ID is already suspended !");
			}
			infoIfExisted.setSuspendedAt(sessionInfo.getSuspendedAt());
			infoIfExisted.setStatus(ChargingSessionStatus.SUSPENDED);
			ChargingSessionInfo savedInfo = chargingSessionRepository.save(infoIfExisted);
			return new ChargingSessionResponse(savedInfo);
		}).orElse(new ChargingSessionResponse("Session with this ID doesn't exist"));
	}

	public ChargingSessionResponse getChargingSession(String id) {
		return chargingSessionRepository.findById(id).map(info -> {
			return new ChargingSessionResponse(info);
		}).orElse(new ChargingSessionResponse("Session with this ID doesn't exist"));
	}

	public ChargingSessionStatisticsResponse getChargingSessionStatistics() {
		return new ChargingSessionStatisticsResponse(1, 1);
	}
}
